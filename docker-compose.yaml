services:
  openclaw:
    build: .
    image: openclaw:0.2.0
    container_name: openclaw
    init: true
    shm_size: "2g"
    cap_add:
      - NET_ADMIN
    volumes:
      - ./data/moltbot-config:/root/.openclaw
      - ./data/moltbot-workspace:/root/openclaw
      # Persisted package manager binaries (brew, npm, go, python)
      - moltbot-brew:/home/linuxbrew/.linuxbrew
      - moltbot-tools:/tools
      # User config and cache
      - moltbot-gitcfg:/root/.gitcfg
      - moltbot-cache:/root/.cache
      - moltbot-config:/root/.config
      - moltbot-ssh:/root/.ssh

    ports:
      - "2222:22"

    healthcheck:
      test: [ "CMD", "openclaw", "health" ]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    environment:
      OPENCLAW_GATEWAY_TOKEN: ${MOLTBOT_GATEWAY_TOKEN}
      # Redsocks: started on boot when REDSOCKS_PROXY_IP is set (local proxy on REDSOCKS_LOCAL_PORT)
      REDSOCKS_PROXY_IP: ${REDSOCKS_PROXY_IP:-}
      REDSOCKS_PROXY_PORT: ${REDSOCKS_PROXY_PORT:-1080}
      REDSOCKS_PROXY_TYPE: ${REDSOCKS_PROXY_TYPE:-socks5}
      REDSOCKS_LOCAL_PORT: ${REDSOCKS_LOCAL_PORT:-12345}
    restart: unless-stopped

volumes:
  moltbot-brew:
  moltbot-tools:
  moltbot-gitcfg:
  moltbot-cache:
  moltbot-config:
  moltbot-ssh:
