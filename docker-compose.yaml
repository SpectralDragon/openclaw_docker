services:

  xray-proxy:
    build:
      context: .
      dockerfile: Dockerfile.proxy
    container_name: xray-proxy
    restart: always
    cap_add:
      - NET_ADMIN
    volumes:
      - ./proxy-config.json:/etc/xray/config.template.json:ro
    environment:
      VLESS_ADDRESS: ${VLESS_ADDRESS}
      VLESS_PORT: ${VLESS_PORT}
      VLESS_UUID: ${VLESS_UUID}
      VLESS_PUBLIC_KEY: ${VLESS_PUBLIC_KEY}
      VLESS_SHORT_ID: ${VLESS_SHORT_ID}
      VLESS_SNI: ${VLESS_SNI:-google.com}
      VLESS_FINGERPRINT: ${VLESS_FINGERPRINT:-chrome}
      VLESS_SPIDER_X: ${VLESS_SPIDER_X:-/}
    ports:
      - "${MOLTBOT_GATEWAY_PORT:-18789}:18789"
      - "${MOLTBOT_BRIDGE_PORT:-18790}:18790"

  openclaw:
    build: .
    image: openclaw:0.1.0
    container_name: openclaw
    init: true
    shm_size: "2g"
    network_mode: "service:xray-proxy"
    depends_on:
      xray-proxy:
        condition: service_started
    volumes:
      - ./data/moltbot-config:/root/.openclaw
      - ./data/moltbot-workspace:/root/openclaw
      # Persisted package manager binaries (brew, npm, go, python)
      - moltbot-brew:/home/linuxbrew/.linuxbrew
      - moltbot-tools:/tools
      # User config and cache
      - moltbot-gitcfg:/root/.gitcfg
      - moltbot-cache:/root/.cache
      - moltbot-config:/root/.config

    healthcheck:
      test: [ "CMD", "openclaw", "health" ]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    environment:
      OPENCLAW_GATEWAY_TOKEN: ${MOLTBOT_GATEWAY_TOKEN}
    restart: unless-stopped

volumes:
  moltbot-brew:
  moltbot-tools:
  moltbot-gitcfg:
  moltbot-cache:
  moltbot-config:
